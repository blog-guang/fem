# 有限元基本理论 (FEM Fundamentals)

本文档介绍有限元方法的数学基础，基于 ANSYS Theory Reference 和经典教材。

---

## 📐 1. 有限元方法概述

### 1.1 基本思想

**核心思想**：将连续域离散化为有限个单元（elements），通过单元内的近似函数表示场变量，将微分方程转化为代数方程组。

**步骤**：
1. **离散化**（Discretization）：将求解域划分为单元网格
2. **单元近似**（Element Approximation）：用形函数表示场变量
3. **单元方程**（Element Equations）：推导单元刚度矩阵和载荷向量
4. **全局装配**（Assembly）：组装全局系统方程
5. **边界条件**（Boundary Conditions）：施加约束和载荷
6. **求解**（Solution）：求解代数方程组
7. **后处理**（Postprocessing）：计算应力、应变等导出量

---

## 🔬 2. 弱形式与虚功原理

### 2.1 强形式（Strong Form）

以弹性力学为例，平衡方程（强形式）：

```
∇·σ + f = 0    in Ω     (平衡方程)
u = ū          on Γ_u   (Dirichlet 边界)
σ·n = t̄        on Γ_t   (Neumann 边界)
```

其中：
- `σ`：Cauchy 应力张量
- `f`：体力
- `u`：位移
- `ū`：给定位移（边界）
- `t̄`：给定面力（边界）
- `n`：外法向量

### 2.2 弱形式（Weak Form）

将强形式乘以测试函数 `δu`（虚位移），在域上积分：

```
∫_Ω δu · (∇·σ + f) dΩ = 0
```

应用分部积分（Green-Gauss 定理）：

```
∫_Ω (∇δu):σ dΩ = ∫_Ω δu·f dΩ + ∫_{Γ_t} δu·t̄ dΓ
```

这就是**虚功原理**（Principle of Virtual Work）：

> 内力虚功 = 外力虚功

### 2.3 Voigt 记号

应力和应变用向量表示（Voigt notation）：

**3D**：
```
σ = [σ_xx, σ_yy, σ_zz, τ_xy, τ_yz, τ_xz]^T  (6×1)
ε = [ε_xx, ε_yy, ε_zz, γ_xy, γ_yz, γ_xz]^T  (6×1)
```

**2D 平面应力**：
```
σ = [σ_xx, σ_yy, τ_xy]^T  (3×1)
ε = [ε_xx, ε_yy, γ_xy]^T  (3×1)
```

---

## 🧮 3. 单元近似

### 3.1 位移场近似

单元内位移用形函数 `N_i` 和节点位移 `u_i` 表示：

```
u(x) ≈ u^h(x) = Σ N_i(x) u_i = N(x) · u^e
```

其中：
- `N_i(x)`：第 i 个节点的形函数
- `u_i`：第 i 个节点的位移
- `u^e`：单元节点位移向量

**形函数性质**：
1. **单位分解**：`Σ N_i = 1`
2. **Kronecker delta**：`N_i(x_j) = δ_ij`
3. **局部支撑**：`N_i` 仅在包含节点 i 的单元上非零

### 3.2 应变-位移关系

应变由位移梯度计算（小应变假设）：

**3D**：
```
ε = ∇_s u = [
    ∂u/∂x,
    ∂v/∂y,
    ∂w/∂z,
    ∂u/∂y + ∂v/∂x,
    ∂v/∂z + ∂w/∂y,
    ∂u/∂z + ∂w/∂x
]
```

离散化后：
```
ε = B · u^e
```

**B 矩阵**（应变-位移矩阵）：
```
B = [
    [∂N1/∂x,   0,       0,       ∂N2/∂x, ...],
    [0,       ∂N1/∂y,   0,       0,      ...],
    [0,        0,      ∂N1/∂z,   0,      ...],
    [∂N1/∂y,  ∂N1/∂x,   0,      ∂N2/∂y, ...],
    [0,       ∂N1/∂z,  ∂N1/∂y,   0,      ...],
    [∂N1/∂z,   0,      ∂N1/∂x,  ∂N2/∂z, ...]
]  (6 × n_dofs)
```

---

## 🏗️ 4. 单元刚度矩阵

### 4.1 本构关系

应力-应变关系（各向同性弹性）：

```
σ = D · ε
```

**弹性刚度矩阵 D**（3D）：

```
D = E/[(1+ν)(1-2ν)] [
    [1-ν,   ν,     ν,      0,      0,      0    ],
    [ν,     1-ν,   ν,      0,      0,      0    ],
    [ν,     ν,     1-ν,    0,      0,      0    ],
    [0,     0,     0,      (1-2ν)/2, 0,    0    ],
    [0,     0,     0,      0,   (1-2ν)/2,  0    ],
    [0,     0,     0,      0,      0,   (1-2ν)/2]
]
```

### 4.2 单元刚度矩阵推导

虚功方程离散化：

```
∫_Ω δε^T · σ dΩ = ∫_Ω δu^T · f dΩ + ∫_{Γ_t} δu^T · t̄ dΓ
```

代入 `ε = B·u^e`, `σ = D·ε = D·B·u^e`：

```
(δu^e)^T ∫_Ω B^T D B dΩ · u^e = (δu^e)^T [∫_Ω N^T f dΩ + ∫_{Γ_t} N^T t̄ dΓ]
```

由于 `δu^e` 任意，得：

```
K^e · u^e = F^e
```

其中：
- **单元刚度矩阵**：`K^e = ∫_Ω B^T D B dΩ`
- **单元载荷向量**：`F^e = ∫_Ω N^T f dΩ + ∫_{Γ_t} N^T t̄ dΓ`

### 4.3 等参单元与数值积分

#### 4.3.1 等参变换

引入局部坐标 `(ξ, η, ζ) ∈ [-1,1]^3`，物理坐标用相同的形函数表示：

```
x(ξ,η,ζ) = Σ N_i(ξ,η,ζ) x_i
y(ξ,η,ζ) = Σ N_i(ξ,η,ζ) y_i
z(ξ,η,ζ) = Σ N_i(ξ,η,ζ) z_i
```

**雅可比矩阵**：

```
J = ∂(x,y,z)/∂(ξ,η,ζ) = [
    [∂x/∂ξ,  ∂y/∂ξ,  ∂z/∂ξ ],
    [∂x/∂η,  ∂y/∂η,  ∂z/∂η ],
    [∂x/∂ζ,  ∂y/∂ζ,  ∂z/∂ζ ]
]
```

**物理坐标导数**：

```
[∂N/∂x]       -1  [∂N/∂ξ]
[∂N/∂y] = J    [∂N/∂η]
[∂N/∂z]        [∂N/∂ζ]
```

#### 4.3.2 高斯积分

单元刚度矩阵的数值积分：

```
K^e = ∫_Ω B^T D B dΩ
    = ∫_{-1}^{+1} ∫_{-1}^{+1} ∫_{-1}^{+1} B^T D B |det(J)| dξ dη dζ
    ≈ Σ_{i=1}^{n_g} w_i · B_i^T D B_i · |det(J_i)|
```

其中：
- `w_i`：高斯积分权重
- `B_i`：第 i 个高斯点的 B 矩阵
- `|det(J_i)|`：第 i 个高斯点的雅可比行列式

**常用高斯点数**：
- **Tri3/Tet4**：1 点（重心）
- **Quad4**：2×2 = 4 点
- **Brick8**：2×2×2 = 8 点
- **Tet10**：4 点（避免 shear locking）
- **Hex20**：3×3×3 = 27 点（完全积分）或 2×2×2 = 8 点（减缩积分）

---

## 🔗 5. 全局装配

### 5.1 直接刚度法

全局刚度矩阵由单元刚度矩阵装配而成：

```
K = A^e (K^e)
```

**装配过程**：
1. 初始化全局矩阵 `K = 0` (n_dofs × n_dofs)
2. 循环所有单元 `e = 1, ..., n_elem`：
   - 计算单元刚度 `K^e`
   - 确定单元 DOF 映射 `loc2glb`（局部→全局）
   - 累加到全局矩阵：`K[i,j] += K^e[i_loc, j_loc]`

### 5.2 稀疏矩阵存储

全局刚度矩阵是**稀疏**的（非零元占比 <1%），使用压缩格式存储：

**CSR (Compressed Sparse Row)**：
```
row_ptr[i]     : 第 i 行的起始索引
col_indices[k] : 第 k 个非零元的列号
values[k]      : 第 k 个非零元的值
```

**优点**：
- 内存占用低（仅存储非零元）
- 矩阵-向量乘法高效（`O(nnz)`）
- 适合迭代求解器

---

## 🛠️ 6. 边界条件

### 6.1 Dirichlet 边界条件

**强加位移**：`u_i = ū_i`

**实现方法（Penalty 法）**：
1. 修改对角元：`K[i,i] = 1e30`
2. 修改载荷：`F[i] = 1e30 · ū_i`

**优点**：不改变矩阵大小，易于实现。

### 6.2 Neumann 边界条件

**强加面力**：`σ·n = t̄`

**实现方法**：将面力贡献加入载荷向量：

```
F^e += ∫_{Γ_t} N^T t̄ dΓ
```

**面积分**：
- 在单元边界（2D）或表面（3D）上积分
- 使用低维高斯积分（1D/2D）

---

## 🔢 7. 线性系统求解

### 7.1 直接法

**LU 分解**（适合小规模问题）：
```
K = L · U
L · U · u = F
→ L · y = F   (前向替代)
→ U · u = y   (后向替代)
```

**优点**：精确求解（数值精度内）  
**缺点**：内存消耗大（`O(n²)`），时间复杂度高（`O(n³)`）

### 7.2 迭代法

**共轭梯度 (CG)**：
```
r_0 = F - K·u_0
p_0 = r_0
for k = 0, 1, 2, ...
    α_k = (r_k, r_k) / (p_k, K·p_k)
    u_{k+1} = u_k + α_k · p_k
    r_{k+1} = r_k - α_k · K·p_k
    β_k = (r_{k+1}, r_{k+1}) / (r_k, r_k)
    p_{k+1} = r_{k+1} + β_k · p_k
```

**收敛判据**：`||r_k|| < tol·||F||`

**优点**：
- 内存占用低（`O(nnz)`）
- 适合大规模问题（百万级 DOF）

**缺点**：
- 收敛速度依赖于条件数
- 需要预条件器加速

### 7.3 预条件器

**目的**：改善条件数，加速收敛

**预条件共轭梯度 (PCG)**：
```
r_0 = F - K·u_0
z_0 = M^{-1}·r_0  ← 预条件器
p_0 = z_0
for k = 0, 1, 2, ...
    α_k = (r_k, z_k) / (p_k, K·p_k)
    u_{k+1} = u_k + α_k · p_k
    r_{k+1} = r_k - α_k · K·p_k
    z_{k+1} = M^{-1}·r_{k+1}  ← 预条件器
    β_k = (r_{k+1}, z_{k+1}) / (r_k, z_k)
    p_{k+1} = z_{k+1} + β_k · p_k
```

**常用预条件器**：
- **Jacobi**：`M = diag(K)`（简单但效果一般）
- **SSOR**：`M = (D + ωL)D^{-1}(D + ωU)`（串行，收敛快）
- **ILU(0)**：不完全 LU 分解（收敛很快）
- **AMG**：代数多重网格（最佳性能，适合椭圆问题）

---

## 📊 8. 后处理

### 8.1 应力计算

**单元中心应力**：在单元中心（或高斯点）计算：

```
σ = D · B · u^e
```

**节点应力**：将单元应力外推到节点，多单元平均：

```
σ_node = Σ w_e · σ_e / Σ w_e
```

权重 `w_e` 可选：
- 单元体积
- 单元质量
- 均匀权重（简单平均）

### 8.2 von Mises 等效应力

**3D**：
```
σ_vm = √[(σ_xx - σ_yy)² + (σ_yy - σ_zz)² + (σ_zz - σ_xx)² 
        + 6(τ_xy² + τ_yz² + τ_xz²)] / √2
```

**2D 平面应力**：
```
σ_vm = √(σ_xx² - σ_xx·σ_yy + σ_yy² + 3τ_xy²)
```

**屈服判据**（von Mises）：
```
f = σ_vm - σ_y ≤ 0
```

### 8.3 反力计算

边界节点的反力：

```
R = K · u - F
```

仅提取 Dirichlet 边界的对应分量。

---

## 🔬 9. 误差与收敛

### 9.1 离散化误差

有限元解 `u^h` 与精确解 `u` 的误差：

```
||u - u^h||_{H^1} ≤ C · h^p
```

其中：
- `h`：单元特征尺寸
- `p`：形函数阶次（线性单元 p=1，二次单元 p=2）
- `C`：常数（依赖问题）

**收敛率**：
- **线性单元**：`O(h)`
- **二次单元**：`O(h²)`

### 9.2 网格加密

**h-refinement**：减小单元尺寸（增加单元数）  
**p-refinement**：提高单元阶次（线性→二次）  
**hp-refinement**：同时进行 h 和 p 细化

---

## 📚 参考文献

1. **Hughes, T.J.R.** (2000). *The Finite Element Method: Linear Static and Dynamic Finite Element Analysis*. Dover.

2. **Zienkiewicz, O.C. & Taylor, R.L.** (2000). *The Finite Element Method*, Volume 1-3. Butterworth-Heinemann.

3. **Bathe, K.J.** (1996). *Finite Element Procedures*. Prentice Hall.

4. **ANSYS Inc.** (2024). *ANSYS Mechanical APDL Theory Reference*. Release 2024 R1.

5. **Belytschko, T., Liu, W.K., Moran, B.** (2000). *Nonlinear Finite Elements for Continua and Structures*. Wiley.

---

**下一节**：[材料本构模型](02-material-models.md)
